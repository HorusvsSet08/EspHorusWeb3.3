<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Datos en Vivo - Horus</title>
  <link rel="stylesheet" href="../css/style.css" />

  <!-- React + Three.js -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/@react-three/fiber@8.15.12/dist/react-three-fiber.umd.js"></script>
  <script src="https://unpkg.com/@react-three/drei@9.88.8/dist/drei.umd.js"></script>

  <style>
    /* üé® Estilos del visor */
    .model-viewer-container {
      position: relative;
      width: 80vw;
      height: 70vh;
      margin: 40px auto;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
      background: #000;
    }

    button.screenshot-btn {
      position: absolute;
      right: 16px;
      top: 16px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border: 1px solid #fff;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      backdrop-filter: blur(8px);
      transition: background 0.2s;
    }

    button.screenshot-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body class="light-mode">
  <nav class="nav">
    <div class="nav-container">
      <div class="nav-buttons">
        <a href="../index.html" class="nav-btn">
          <span class="nav-icon">üè†</span> Inicio
        </a>
        <a href="mqtt.html" class="nav-btn active">
          <span class="nav-icon">üì°</span> Datos en Vivo
        </a>
        <a href="analisis.html" class="nav-btn">
          <span class="nav-icon">üìä</span> An√°lisis
        </a>
        <a href="chatbot.html" class="nav-btn">
          <span class="nav-icon">ü§ñ</span> Chatbot
        </a>
      </div>

      <div class="nav-right">
        <label class="theme-switch">
          <input type="checkbox" class="theme-switch__checkbox">
          <div class="theme-switch__container">
            <div class="theme-switch__clouds"></div>
            <div class="theme-switch__stars-container">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 55" fill="none">
                <path d="M135.831 3.00688C135.055 3.85027 134.111 4.29946 133 4.35447C134.111 4.40947 135.055 4.85867 135.831 5.71123C136.607 6.55462 136.996 7.56303 136.996 8.72727C136.996 7.95722 137.172 7.25134 137.525 6.59129C137.886 5.93124 138.372 5.39954 138.98 5.00535C139.598 4.60199 140.268 4.39114 141 4.35447C139.88 4.2903 138.936 3.85027 138.16 3.00688C137.384 2.16348 136.996 1.16425 136.996 0C136.996 1.16425 136.607 2.16348 135.831 3.00688Z" fill="currentColor"/>
              </svg>
            </div>
            <div class="theme-switch__circle-container">
              <div class="theme-switch__sun-moon-container">
                <div class="theme-switch__moon">
                  <div class="theme-switch__spot"></div>
                  <div class="theme-switch__spot"></div>
                  <div class="theme-switch__spot"></div>
                </div>
              </div>
            </div>
          </div>
        </label>
      </div>
    </div>
  </nav>

  <!-- Estado de conexi√≥n -->
  <div class="connection-status-small">
    <span class="status-dot"></span>
    <span class="status-text">Conectando...</span>
    <div class="last-update">√∫ltima: nunca</div>
  </div>

  <div class="container">
    <header>
      <h1>üõ∞Ô∏è Visor 3D - Estaci√≥n Horus</h1>
      <p class="dashboard-description">Visualiza el modelo 3D de la estaci√≥n o componentes meteorol√≥gicos (STL / GLB / GLTF).</p>
    </header>

    <!-- üëá AQU√ç VA EL VISOR -->
    <div id="viewer-root"></div>

    <footer>
      <p>Estaci√≥n Horus ‚Ä¢ Dise√±o y desarrollo por <strong>Tu Nombre</strong></p>
    </footer>
  </div>

  <!-- üß† STLLoader compatible para navegador -->
  <script>
    class STLLoader extends THREE.Loader {
      constructor(manager) { super(manager); }
      load(url, onLoad, onProgress, onError) {
        const loader = new THREE.FileLoader(this.manager);
        loader.setPath(this.path);
        loader.setResponseType('arraybuffer');
        loader.load(url, (data) => onLoad(this.parse(data)), onProgress, onError);
      }
      parse(data) {
        const isBinary = (data) => {
          const str = new TextDecoder().decode(new Uint8Array(data, 0, 80));
          return str.indexOf("solid") !== 0;
        };
        if (isBinary(data)) {
          const reader = new DataView(data);
          const faces = reader.getUint32(80, true);
          let offset = 84;
          const geo = new THREE.BufferGeometry();
          const vertices = [];
          const normals = [];
          for (let i = 0; i < faces; i++) {
            const normalX = reader.getFloat32(offset, true);
            const normalY = reader.getFloat32(offset + 4, true);
            const normalZ = reader.getFloat32(offset + 8, true);
            offset += 12;
            for (let j = 0; j < 3; j++) {
              vertices.push(
                reader.getFloat32(offset, true),
                reader.getFloat32(offset + 4, true),
                reader.getFloat32(offset + 8, true)
              );
              normals.push(normalX, normalY, normalZ);
              offset += 12;
            }
            offset += 2;
          }
          geo.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
          geo.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
          return geo;
        } else {
          const text = new TextDecoder().decode(data);
          const patternFace = /facet([\s\S]*?)endfacet/g;
          const geo = new THREE.BufferGeometry();
          const vertices = [];
          const normals = [];
          let result;
          while ((result = patternFace.exec(text)) !== null) {
            const normalMatch = /normal([\s\S]*?)outer/.exec(result[1]);
            const vertexMatch = [...result[1].matchAll(/vertex\s+([^\s]+)\s+([^\s]+)\s+([^\s]+)/g)];
            if (normalMatch && vertexMatch.length === 3) {
              const n = normalMatch[1].trim().split(/\s+/).map(Number);
              for (const v of vertexMatch) {
                vertices.push(parseFloat(v[1]), parseFloat(v[2]), parseFloat(v[3]));
                normals.push(n[0], n[1], n[2]);
              }
            }
          }
          geo.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
          geo.setAttribute('normal', new THREE.Float32BufferAttribute(normals, 3));
          return geo;
        }
      }
    }
  </script>

  <!-- üì¶ Script del visor 3D -->
  <script type="text/babel">
    const { Canvas, useLoader } = ReactThreeFiber;
    const { OrbitControls, useGLTF, Environment, ContactShadows, Html } = drei;

    function Loader() {
      return (
        <Html center>
          <div style={{ color: 'white' }}>Cargando modelo...</div>
        </Html>
      );
    }

    function Model({ url }) {
      const ext = url.split('.').pop().toLowerCase();
      if (ext === 'glb' || ext === 'gltf') {
        const gltf = useGLTF(url);
        return <primitive object={gltf.scene} dispose={null} />;
      } else if (ext === 'stl') {
        const geom = useLoader(STLLoader, url);
        return (
          <mesh geometry={geom} rotation={[-Math.PI / 2, 0, 0]}>
            <meshStandardMaterial color="#9ecfff" metalness={0.3} roughness={0.6} />
          </mesh>
        );
      } else {
        return (
          <Html center>
            <div style={{ color: 'red' }}>Formato no soportado: {ext}</div>
          </Html>
        );
      }
    }

    function Viewer3D({ url }) {
      const capture = () => {
        const canvas = document.querySelector('canvas');
        const link = document.createElement('a');
        link.download = 'screenshot.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      };

      return (
        <div className="model-viewer-container">
          <button className="screenshot-btn" onClick={capture}>üì∏ Captura</button>
          <Canvas
            shadows
            camera={{ position: [0, 0.5, 3], fov: 50 }}
            gl={{ preserveDrawingBuffer: true }}
          >
            <ambientLight intensity={0.5} />
            <directionalLight position={[4, 4, 4]} intensity={1} castShadow />
            <Suspense fallback={<Loader />}>
              <Model url={url} />
              <Environment preset="city" />
            </Suspense>
            <ContactShadows position={[0, -0.8, 0]} opacity={0.4} scale={10} blur={2} />
            <OrbitControls enablePan={false} />
          </Canvas>
        </div>
      );
    }

    // üîπ Render principal
    ReactDOM.createRoot(document.getElementById('viewer-root')).render(
      <React.Suspense fallback={<div style={{ color: "white" }}>Cargando...</div>}>
        {/* Cambia esta URL a tu modelo STL o GLB */}
        <Viewer3D url="https://threejs.org/examples/models/stl/ascii/slotted_disk.stl" />
      </React.Suspense>
    );
  </script>

  <!-- Tu script original -->
  <script src="../js/main.js"></script>
</body>
</html>
